<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AppRestControllerAdvice.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">assure</a> &gt; <a href="index.source.html" class="el_package">com.assure.controller</a> &gt; <span class="el_source">AppRestControllerAdvice.java</span></div><h1>AppRestControllerAdvice.java</h1><pre class="source lang-java linenums">package com.assure.controller;

import com.commons.service.ApiException;
import com.commons.service.CustomErrorResponse;
import com.commons.service.CustomValidationException;
import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.http.converter.HttpMessageNotReadableException;
import org.springframework.http.converter.HttpMessageNotWritableException;
import org.springframework.web.HttpMediaTypeNotSupportedException;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.MissingServletRequestParameterException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.context.request.ServletWebRequest;
import org.springframework.web.context.request.WebRequest;
import org.springframework.web.method.annotation.MethodArgumentTypeMismatchException;
import org.springframework.web.servlet.NoHandlerFoundException;
import org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler;

import javax.validation.ConstraintViolationException;
import java.util.Arrays;

import static org.springframework.http.HttpStatus.*;

@RestControllerAdvice
<span class="fc" id="L30">public class AppRestControllerAdvice extends ResponseEntityExceptionHandler {</span>

//	private static final String BAD_REQUEST = &quot;BAD_REQUEST&quot;;

//	@ExceptionHandler(ApiException.class)
//	@ResponseStatus(NOT_FOUND)
//	public MessageData handleException(ApiException e) {
//		MessageData data = new MessageData();
//		data.setCode(NOT_FOUND);
//		data.setMessage(e.getMessage());
//		return data;
//	}

//
//	@ResponseStatus(HttpStatus.BAD_REQUEST)
//	@ExceptionHandler(MethodArgumentNotValidException.class)
//	public ResponseEntity&lt;Object&gt; handleValidationExceptions(
//			MethodArgumentNotValidException ex) {
////		Map&lt;String, String&gt; errors = new HashMap&lt;&gt;();
////		ex.getBindingResult().getAllErrors().forEach((error) -&gt; {
////			String fieldName = ((FieldError) error).getField();
////			String errorMessage = error.getDefaultMessage();
////			errors.put(fieldName, errorMessage);
////		});
////		return errors;
//
//		CustomErrorResponse apiError = new CustomErrorResponse(BAD_REQUEST);
//		apiError.setMessage(&quot;Validation error&quot;);
//		apiError.addValidationErrors(ex.getBindingResult().getFieldErrors());
//		apiError.addValidationError(ex.getBindingResult().getGlobalErrors());
//		return buildResponseEntity(apiError);
//	}
//
//	@ExceptionHandler(ApiException.class)
//	protected ResponseEntity&lt;Object&gt; handleEntityNotFound(
//			ApiException ex) {
//		CustomErrorResponse apiError = new CustomErrorResponse(NOT_FOUND);
//		apiError.setMessage(ex.getMessage());
//		return buildResponseEntity(apiError);
//	}
//
//	@ExceptionHandler(HttpMessageNotReadableException.class)
//	protected ResponseEntity&lt;Object&gt; handleHttpMessageNotReadable(HttpMessageNotReadableException ex) {
//		String error = &quot;Malformed JSON request&quot;;
//		return buildResponseEntity(new CustomErrorResponse(HttpStatus.BAD_REQUEST, error, ex));
//	}
//
//	private ResponseEntity&lt;Object&gt; buildResponseEntity(CustomErrorResponse apiError) {
//		return new ResponseEntity&lt;&gt;(apiError, apiError.getStatus());
//	}
//
////	@ExceptionHandler(ApiException.class)
////	@ResponseStatus(HttpStatus.BAD_REQUEST)
////	public Failure handle(ApiException e) {
////		return new Failure(e.getFormattedErrors());
////	}
//
	@ExceptionHandler(Throwable.class)
	@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
	public ResponseEntity&lt;Object&gt; handle(Throwable e) {
<span class="nc bnc" id="L90" title="All 2 branches missed.">		if (e.getCause() instanceof ConstraintViolationException) {</span>
<span class="nc" id="L91">			return buildResponseEntity(new CustomErrorResponse(HttpStatus.CONFLICT, &quot;Database error&quot;, e.getCause()));</span>
		}
<span class="nc" id="L93">		CustomErrorResponse apiError = new CustomErrorResponse(INTERNAL_SERVER_ERROR);</span>
<span class="nc" id="L94">		apiError.setMessage(&quot;Server Error occurred.&quot;);</span>
<span class="nc" id="L95">		apiError.setMessage(&quot;An unknown internal error has occurred - &quot; + e.getMessage());</span>
<span class="nc" id="L96">		apiError.setDebugMessage(Arrays.toString(e.getStackTrace()));</span>
<span class="nc" id="L97">		return buildResponseEntity(apiError);</span>
	}

	/**
	 * Handle MissingServletRequestParameterException. Triggered when a 'required' request parameter is missing.
	 *
	 * @param ex      MissingServletRequestParameterException
	 * @param headers HttpHeaders
	 * @param status  HttpStatus
	 * @param request WebRequest
	 * @return the CustomErrorResponse object
	 */
	@Override
	protected ResponseEntity&lt;Object&gt; handleMissingServletRequestParameter(
			MissingServletRequestParameterException ex, HttpHeaders headers,
			HttpStatus status, WebRequest request) {
<span class="nc" id="L113">		String error = ex.getParameterName() + &quot; parameter is missing&quot;;</span>
<span class="nc" id="L114">		return buildResponseEntity(new CustomErrorResponse(BAD_REQUEST, error, ex));</span>
	}


	/**
	 * Handle HttpMediaTypeNotSupportedException. This one triggers when JSON is invalid as well.
	 *
	 * @param ex      HttpMediaTypeNotSupportedException
	 * @param headers HttpHeaders
	 * @param status  HttpStatus
	 * @param request WebRequest
	 * @return the CustomErrorResponse object
	 */
	@Override
	protected ResponseEntity&lt;Object&gt; handleHttpMediaTypeNotSupported(
			HttpMediaTypeNotSupportedException ex,
			HttpHeaders headers,
			HttpStatus status,
			WebRequest request) {
<span class="nc" id="L133">		StringBuilder builder = new StringBuilder();</span>
<span class="nc" id="L134">		builder.append(ex.getContentType());</span>
<span class="nc" id="L135">		builder.append(&quot; media type is not supported. Supported media types are &quot;);</span>
<span class="nc" id="L136">		ex.getSupportedMediaTypes().forEach(t -&gt; builder.append(t).append(&quot;, &quot;));</span>
<span class="nc" id="L137">		return buildResponseEntity(new CustomErrorResponse(HttpStatus.UNSUPPORTED_MEDIA_TYPE, builder.substring(0, builder.length() - 2), ex));</span>
	}

	/**
	 * Handle MethodArgumentNotValidException. Triggered when an object fails @Valid validation.
	 *
	 * @param ex      the MethodArgumentNotValidException that is thrown when @Valid validation fails
	 * @param headers HttpHeaders
	 * @param status  HttpStatus
	 * @param request WebRequest
	 * @return the CustomErrorResponse object
	 */
	@Override
	protected ResponseEntity&lt;Object&gt; handleMethodArgumentNotValid(
			MethodArgumentNotValidException ex,
			HttpHeaders headers,
			HttpStatus status,
			WebRequest request) {
<span class="nc" id="L155">		CustomErrorResponse apiError = new CustomErrorResponse(BAD_REQUEST);</span>
<span class="nc" id="L156">		apiError.setMessage(&quot;Validation error&quot;);</span>
<span class="nc" id="L157">		apiError.addValidationErrors(ex.getBindingResult().getFieldErrors());</span>
<span class="nc" id="L158">		apiError.addValidationError(ex.getBindingResult().getGlobalErrors());</span>
<span class="nc" id="L159">		return buildResponseEntity(apiError);</span>
	}

	/**
	 * Handles javax.validation.ConstraintViolationException. Thrown when @Validated fails.
	 *
	 * @param ex the ConstraintViolationException
	 * @return the CustomErrorResponse object
	 */
	@ExceptionHandler(ConstraintViolationException.class)
	protected ResponseEntity&lt;Object&gt; handleConstraintViolation(ConstraintViolationException ex) {
<span class="nc" id="L170">		CustomErrorResponse apiError = new CustomErrorResponse(BAD_REQUEST);</span>
<span class="nc" id="L171">		apiError.setMessage(&quot;Validation error&quot;);</span>
<span class="nc" id="L172">		apiError.addValidationErrors(ex.getConstraintViolations());</span>
<span class="nc" id="L173">		return buildResponseEntity(apiError);</span>
	}

	@ExceptionHandler(CustomValidationException.class)
	protected ResponseEntity&lt;Object&gt; handleCustomConstraintViolation(
			CustomValidationException ex) {
<span class="nc" id="L179">		CustomErrorResponse apiError = new CustomErrorResponse(BAD_REQUEST);</span>
<span class="nc" id="L180">		apiError.setMessage(&quot;Validation error&quot;);</span>
<span class="nc" id="L181">		apiError.addValidationErrors(ex.getFormattedErrors());</span>
<span class="nc" id="L182">		return buildResponseEntity(apiError);</span>
	}

	/**
	 * Handles ApiException. Created to encapsulate errors with more detail than javax.persistence.EntityNotFoundException.
	 *
	 * @param ex the ApiException
	 * @return the CustomErrorResponse object
	 */
	@ExceptionHandler(ApiException.class)
	protected ResponseEntity&lt;Object&gt; handleEntityNotFound(ApiException ex) {
<span class="nc" id="L193">		CustomErrorResponse apiError = new CustomErrorResponse(NOT_FOUND);</span>
<span class="nc" id="L194">		apiError.setMessage(ex.getMessage());</span>
<span class="nc" id="L195">		return buildResponseEntity(apiError);</span>
	}

	/**
	 * Handle HttpMessageNotReadableException. Happens when request JSON is malformed.
	 *
	 * @param ex      HttpMessageNotReadableException
	 * @param headers HttpHeaders
	 * @param status  HttpStatus
	 * @param request WebRequest
	 * @return the CustomErrorResponse object
	 */
	@Override
	protected ResponseEntity&lt;Object&gt; handleHttpMessageNotReadable(HttpMessageNotReadableException ex, HttpHeaders headers, HttpStatus status, WebRequest request) {
<span class="nc" id="L209">		ServletWebRequest servletWebRequest = (ServletWebRequest) request;</span>
<span class="nc" id="L210">		String error = &quot;Malformed JSON request&quot;;</span>
<span class="nc" id="L211">		return buildResponseEntity(new CustomErrorResponse(HttpStatus.BAD_REQUEST, error, ex));</span>
	}

	/**
	 * Handle HttpMessageNotWritableException.
	 *
	 * @param ex      HttpMessageNotWritableException
	 * @param headers HttpHeaders
	 * @param status  HttpStatus
	 * @param request WebRequest
	 * @return the CustomErrorResponse object
	 */
	@Override
	protected ResponseEntity&lt;Object&gt; handleHttpMessageNotWritable(HttpMessageNotWritableException ex, HttpHeaders headers, HttpStatus status, WebRequest request) {
<span class="nc" id="L225">		String error = &quot;Error writing JSON output&quot;;</span>
<span class="nc" id="L226">		return buildResponseEntity(new CustomErrorResponse(HttpStatus.INTERNAL_SERVER_ERROR, error, ex));</span>
	}

	/**
	 * Handle NoHandlerFoundException.
	 *
	 * @param ex
	 * @param headers
	 * @param status
	 * @param request
	 * @return
	 */
	@Override
	protected ResponseEntity&lt;Object&gt; handleNoHandlerFoundException(
			NoHandlerFoundException ex, HttpHeaders headers, HttpStatus status, WebRequest request) {
<span class="nc" id="L241">		CustomErrorResponse apiError = new CustomErrorResponse(BAD_REQUEST);</span>
<span class="nc" id="L242">		apiError.setMessage(String.format(&quot;Could not find the %s method for URL %s&quot;, ex.getHttpMethod(), ex.getRequestURL()));</span>
<span class="nc" id="L243">		apiError.setDebugMessage(ex.getMessage());</span>
<span class="nc" id="L244">		return buildResponseEntity(apiError);</span>
	}

	/**
	 * Handle javax.persistence.EntityNotFoundException
	 */
	@ExceptionHandler(javax.persistence.EntityNotFoundException.class)
	protected ResponseEntity&lt;Object&gt; handleEntityNotFound(javax.persistence.EntityNotFoundException ex) {
<span class="nc" id="L252">		return buildResponseEntity(new CustomErrorResponse(HttpStatus.NOT_FOUND, ex));</span>
	}

	/**
	 * Handle DataIntegrityViolationException, inspects the cause for different DB causes.
	 *
	 * @param ex the DataIntegrityViolationException
	 * @return the CustomErrorResponse object
	 */
	@ExceptionHandler(DataIntegrityViolationException.class)
	protected ResponseEntity&lt;Object&gt; handleDataIntegrityViolation(DataIntegrityViolationException ex) {
<span class="nc bnc" id="L263" title="All 2 branches missed.">		if (ex.getCause() instanceof ConstraintViolationException) {</span>
<span class="nc" id="L264">			return buildResponseEntity(new CustomErrorResponse(HttpStatus.CONFLICT, &quot;Database error&quot;, ex.getCause()));</span>
		}
<span class="nc" id="L266">		return buildResponseEntity(new CustomErrorResponse(HttpStatus.INTERNAL_SERVER_ERROR, ex));</span>
	}

	/**
	 * Handle Exception, handle generic Exception.class
	 *
	 * @param ex the Exception
	 * @return the CustomErrorResponse object
	 */
	@ExceptionHandler(MethodArgumentTypeMismatchException.class)
	protected ResponseEntity&lt;Object&gt; handleMethodArgumentTypeMismatch(MethodArgumentTypeMismatchException ex,
																	  WebRequest request) {
<span class="nc" id="L278">		CustomErrorResponse apiError = new CustomErrorResponse(BAD_REQUEST);</span>
<span class="nc" id="L279">		apiError.setMessage(String.format(&quot;The parameter '%s' of value '%s' could not be converted to type '%s'&quot;, ex.getName(), ex.getValue(), ex.getRequiredType().getSimpleName()));</span>
<span class="nc" id="L280">		apiError.setDebugMessage(ex.getMessage());</span>
<span class="nc" id="L281">		return buildResponseEntity(apiError);</span>
	}

	private ResponseEntity&lt;Object&gt; buildResponseEntity(CustomErrorResponse apiError) {
<span class="nc" id="L285">		return new ResponseEntity&lt;&gt;(apiError, apiError.getStatus());</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>