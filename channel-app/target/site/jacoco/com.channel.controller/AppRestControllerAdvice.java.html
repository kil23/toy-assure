<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AppRestControllerAdvice.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">channel-app</a> &gt; <a href="index.source.html" class="el_package">com.channel.controller</a> &gt; <span class="el_source">AppRestControllerAdvice.java</span></div><h1>AppRestControllerAdvice.java</h1><pre class="source lang-java linenums">package com.channel.controller;

import com.commons.service.ApiException;
import com.commons.service.CustomErrorResponse;
import com.commons.service.CustomValidationException;
import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.http.converter.HttpMessageNotReadableException;
import org.springframework.http.converter.HttpMessageNotWritableException;
import org.springframework.web.HttpMediaTypeNotSupportedException;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.MissingServletRequestParameterException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.context.request.ServletWebRequest;
import org.springframework.web.context.request.WebRequest;
import org.springframework.web.method.annotation.MethodArgumentTypeMismatchException;
import org.springframework.web.servlet.NoHandlerFoundException;
import org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler;

import javax.validation.ConstraintViolationException;
import java.util.Arrays;

import static org.springframework.http.HttpStatus.*;
import static org.springframework.http.HttpStatus.BAD_REQUEST;

@RestControllerAdvice
<span class="fc" id="L31">public class AppRestControllerAdvice extends ResponseEntityExceptionHandler {</span>

//	@ExceptionHandler(ApiException.class)
//	@ResponseStatus(HttpStatus.BAD_REQUEST)
//	public MessageData handle(ApiException e) {
//		MessageData data = new MessageData();
//		data.setMessage(e.getMessage());
//		return data;
//	}
//
//	@ExceptionHandler(Throwable.class)
//	@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
//	public MessageData handle(Throwable e) {
//		MessageData data = new MessageData();
//		data.setMessage(&quot;An unknown error has occurred - &quot; + Arrays.toString(e.getStackTrace()));
//		return data;
//	}

	@ExceptionHandler(Throwable.class)
	@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
	public ResponseEntity&lt;Object&gt; handle(Throwable e) {
<span class="nc" id="L52">		CustomErrorResponse apiError = new CustomErrorResponse(INTERNAL_SERVER_ERROR);</span>
<span class="nc" id="L53">		apiError.setMessage(&quot;Server Error occurred.&quot;);</span>
<span class="nc" id="L54">		apiError.setMessage(&quot;An unknown internal error has occurred - &quot; + e.getMessage());</span>
<span class="nc" id="L55">		apiError.setDebugMessage(Arrays.toString(e.getStackTrace()));</span>
<span class="nc" id="L56">		return buildResponseEntity(apiError);</span>
	}

	/**
	 * Handle MissingServletRequestParameterException. Triggered when a 'required' request parameter is missing.
	 *
	 * @param ex      MissingServletRequestParameterException
	 * @param headers HttpHeaders
	 * @param status  HttpStatus
	 * @param request WebRequest
	 * @return the CustomErrorResponse object
	 */
	@Override
	protected ResponseEntity&lt;Object&gt; handleMissingServletRequestParameter(
			MissingServletRequestParameterException ex, HttpHeaders headers,
			HttpStatus status, WebRequest request) {
<span class="nc" id="L72">		String error = ex.getParameterName() + &quot; parameter is missing&quot;;</span>
<span class="nc" id="L73">		return buildResponseEntity(new CustomErrorResponse(BAD_REQUEST, error, ex));</span>
	}

	/**
	 * Handle HttpMediaTypeNotSupportedException. This one triggers when JSON is invalid as well.
	 *
	 * @param ex      HttpMediaTypeNotSupportedException
	 * @param headers HttpHeaders
	 * @param status  HttpStatus
	 * @param request WebRequest
	 * @return the CustomErrorResponse object
	 */
	@Override
	protected ResponseEntity&lt;Object&gt; handleHttpMediaTypeNotSupported(
			HttpMediaTypeNotSupportedException ex,
			HttpHeaders headers,
			HttpStatus status,
			WebRequest request) {
<span class="nc" id="L91">		StringBuilder builder = new StringBuilder();</span>
<span class="nc" id="L92">		builder.append(ex.getContentType());</span>
<span class="nc" id="L93">		builder.append(&quot; media type is not supported. Supported media types are &quot;);</span>
<span class="nc" id="L94">		ex.getSupportedMediaTypes().forEach(t -&gt; builder.append(t).append(&quot;, &quot;));</span>
<span class="nc" id="L95">		return buildResponseEntity(new CustomErrorResponse(HttpStatus.UNSUPPORTED_MEDIA_TYPE, builder.substring(0, builder.length() - 2), ex));</span>
	}

	/**
	 * Handle MethodArgumentNotValidException. Triggered when an object fails @Valid validation.
	 *
	 * @param ex      the MethodArgumentNotValidException that is thrown when @Valid validation fails
	 * @param headers HttpHeaders
	 * @param status  HttpStatus
	 * @param request WebRequest
	 * @return the CustomErrorResponse object
	 */
	@Override
	protected ResponseEntity&lt;Object&gt; handleMethodArgumentNotValid(MethodArgumentNotValidException ex,
																  HttpHeaders headers,
																  HttpStatus status,
																  WebRequest request) {
<span class="nc" id="L112">		CustomErrorResponse apiError = new CustomErrorResponse(BAD_REQUEST);</span>
<span class="nc" id="L113">		apiError.setMessage(&quot;Validation error&quot;);</span>
<span class="nc" id="L114">		apiError.addValidationErrors(ex.getBindingResult().getFieldErrors());</span>
<span class="nc" id="L115">		apiError.addValidationError(ex.getBindingResult().getGlobalErrors());</span>
<span class="nc" id="L116">		return buildResponseEntity(apiError);</span>
	}

	/**
	 * Handles javax.validation.ConstraintViolationException. Thrown when @Validated fails.
	 *
	 * @param ex the ConstraintViolationException
	 * @return the CustomErrorResponse object
	 */
	@ExceptionHandler(ConstraintViolationException.class)
	protected ResponseEntity&lt;Object&gt; handleConstraintViolation(ConstraintViolationException ex) {
<span class="nc" id="L127">		CustomErrorResponse apiError = new CustomErrorResponse(BAD_REQUEST);</span>
<span class="nc" id="L128">		apiError.setMessage(&quot;Validation error&quot;);</span>
<span class="nc" id="L129">		apiError.addValidationErrors(ex.getConstraintViolations());</span>
<span class="nc" id="L130">		return buildResponseEntity(apiError);</span>
	}

	@ExceptionHandler(CustomValidationException.class)
	protected ResponseEntity&lt;Object&gt; handleCustomConstraintViolation(CustomValidationException ex) {
<span class="nc" id="L135">		CustomErrorResponse apiError = new CustomErrorResponse(BAD_REQUEST);</span>
<span class="nc" id="L136">		apiError.setMessage(&quot;Validation error&quot;);</span>
<span class="nc" id="L137">		apiError.addValidationErrors(ex.getFormattedErrors());</span>
<span class="nc" id="L138">		return buildResponseEntity(apiError);</span>
	}

	/**
	 * Handles ApiException. Created to encapsulate errors with more detail than javax.persistence.EntityNotFoundException.
	 *
	 * @param ex the ApiException
	 * @return the CustomErrorResponse object
	 */
	@ExceptionHandler(ApiException.class)
	protected ResponseEntity&lt;Object&gt; handleEntityNotFound(ApiException ex) {
<span class="nc" id="L149">		CustomErrorResponse apiError = new CustomErrorResponse(NOT_FOUND);</span>
<span class="nc" id="L150">		apiError.setMessage(ex.getMessage());</span>
<span class="nc" id="L151">		return buildResponseEntity(apiError);</span>
	}

	/**
	 * Handle HttpMessageNotReadableException. Happens when request JSON is malformed.
	 *
	 * @param ex      HttpMessageNotReadableException
	 * @param headers HttpHeaders
	 * @param status  HttpStatus
	 * @param request WebRequest
	 * @return the CustomErrorResponse object
	 */
	@Override
	protected ResponseEntity&lt;Object&gt; handleHttpMessageNotReadable(HttpMessageNotReadableException ex,
																  HttpHeaders headers,
																  HttpStatus status,
																  WebRequest request) {
<span class="nc" id="L168">		ServletWebRequest servletWebRequest = (ServletWebRequest) request;</span>
<span class="nc" id="L169">		String error = &quot;Malformed JSON request&quot;;</span>
<span class="nc" id="L170">		return buildResponseEntity(new CustomErrorResponse(HttpStatus.BAD_REQUEST, error, ex));</span>
	}

	/**
	 * Handle HttpMessageNotWritableException.
	 *
	 * @param ex      HttpMessageNotWritableException
	 * @param headers HttpHeaders
	 * @param status  HttpStatus
	 * @param request WebRequest
	 * @return the CustomErrorResponse object
	 */
	@Override
	protected ResponseEntity&lt;Object&gt; handleHttpMessageNotWritable(HttpMessageNotWritableException ex,
																  HttpHeaders headers,
																  HttpStatus status,
																  WebRequest request) {
<span class="nc" id="L187">		String error = &quot;Error writing JSON output&quot;;</span>
<span class="nc" id="L188">		return buildResponseEntity(new CustomErrorResponse(HttpStatus.INTERNAL_SERVER_ERROR, error, ex));</span>
	}

	/**
	 * Handle NoHandlerFoundException.
	 *
	 * @param ex
	 * @param headers
	 * @param status
	 * @param request
	 * @return
	 */
	@Override
	protected ResponseEntity&lt;Object&gt; handleNoHandlerFoundException(
			NoHandlerFoundException ex, HttpHeaders headers, HttpStatus status, WebRequest request) {
<span class="nc" id="L203">		CustomErrorResponse apiError = new CustomErrorResponse(BAD_REQUEST);</span>
<span class="nc" id="L204">		apiError.setMessage(String.format(&quot;Could not find the %s method for URL %s&quot;, ex.getHttpMethod(), ex.getRequestURL()));</span>
<span class="nc" id="L205">		apiError.setDebugMessage(ex.getMessage());</span>
<span class="nc" id="L206">		return buildResponseEntity(apiError);</span>
	}

	/**
	 * Handle javax.persistence.EntityNotFoundException
	 */
	@ExceptionHandler(javax.persistence.EntityNotFoundException.class)
	protected ResponseEntity&lt;Object&gt; handleEntityNotFound(javax.persistence.EntityNotFoundException ex) {
<span class="nc" id="L214">		return buildResponseEntity(new CustomErrorResponse(HttpStatus.NOT_FOUND, ex));</span>
	}

	/**
	 * Handle DataIntegrityViolationException, inspects the cause for different DB causes.
	 *
	 * @param ex the DataIntegrityViolationException
	 * @return the CustomErrorResponse object
	 */
	@ExceptionHandler(DataIntegrityViolationException.class)
	protected ResponseEntity&lt;Object&gt; handleDataIntegrityViolation(DataIntegrityViolationException ex) {
<span class="nc bnc" id="L225" title="All 2 branches missed.">		if (ex.getCause() instanceof ConstraintViolationException) {</span>
<span class="nc" id="L226">			return buildResponseEntity(new CustomErrorResponse(HttpStatus.CONFLICT, &quot;Database error&quot;, ex.getCause()));</span>
		}
<span class="nc" id="L228">		return buildResponseEntity(new CustomErrorResponse(HttpStatus.INTERNAL_SERVER_ERROR, ex));</span>
	}

	/**
	 * Handle Exception, handle generic Exception.class
	 *
	 * @param ex the Exception
	 * @return the CustomErrorResponse object
	 */
	@ExceptionHandler(MethodArgumentTypeMismatchException.class)
	protected ResponseEntity&lt;Object&gt; handleMethodArgumentTypeMismatch(MethodArgumentTypeMismatchException ex) {
<span class="nc" id="L239">		CustomErrorResponse apiError = new CustomErrorResponse(BAD_REQUEST);</span>
<span class="nc" id="L240">		apiError.setMessage(String.format(&quot;The parameter '%s' of value '%s' could not be converted to type '%s'&quot;, ex.getName(), ex.getValue(), ex.getRequiredType().getSimpleName()));</span>
<span class="nc" id="L241">		apiError.setDebugMessage(ex.getMessage());</span>
<span class="nc" id="L242">		return buildResponseEntity(apiError);</span>
	}

	private ResponseEntity&lt;Object&gt; buildResponseEntity(CustomErrorResponse apiError) {
<span class="nc" id="L246">		return new ResponseEntity&lt;&gt;(apiError, apiError.getStatus());</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>