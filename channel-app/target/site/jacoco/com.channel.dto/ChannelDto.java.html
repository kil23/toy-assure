<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ChannelDto.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">channel-app</a> &gt; <a href="index.source.html" class="el_package">com.channel.dto</a> &gt; <span class="el_source">ChannelDto.java</span></div><h1>ChannelDto.java</h1><pre class="source lang-java linenums">package com.channel.dto;

import com.channel.api.ChannelApi;
import com.channel.api.ChannelListingApi;
import com.channel.client.ClientClient;
import com.channel.client.InvoicePdfClient;
import com.channel.client.OrderClient;
import com.channel.client.OrderItemClient;
import com.channel.model.form.AddChannelForm;
import com.channel.pojo.Channel;
import com.channel.pojo.ChannelListing;
import com.commons.form.ChannelForm;
import com.commons.form.ChannelOrderForm;
import com.commons.response.*;
import com.commons.service.ApiException;
import com.commons.util.ConvertUtil;
import com.commons.util.PDFHandler;
import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.Base64;
import java.util.List;
import java.util.Set;

@Component
<span class="fc" id="L33">public class ChannelDto {</span>

<span class="fc" id="L35">    private static final Logger logger = Logger.getLogger(ChannelDto.class);</span>
    private static final String PDF_PATH = &quot;src/main/resources/com/channel/&quot;;
    private static final String INVOICE_TEMPLATE_XSL = &quot;src/main/resources/com/channel/invoiceTemplate.xsl&quot;;

    @Autowired private ChannelApi channelApi;
    @Autowired private ChannelListingApi channelListingApi;
    @Autowired private OrderClient orderClient;
    @Autowired private ClientClient clientClient;
    @Autowired private InvoicePdfClient pdfClient;
    @Autowired private OrderItemClient itemClient;

    @Transactional
    public void addChannel(AddChannelForm form) {
<span class="fc bfc" id="L48" title="All 2 branches covered.">        for(ChannelForm formData : form.getChannelList()){</span>
<span class="fc" id="L49">            Channel channel = ConvertUtil.convert(formData, Channel.class);</span>
<span class="pc bpc" id="L50" title="1 of 2 branches missed.">            if (channel != null) {</span>
<span class="fc" id="L51">                channelApi.addChannel(channel);</span>
            }
<span class="fc" id="L53">        }</span>
<span class="fc" id="L54">    }</span>

    @Transactional
    public void updateChannel(ChannelForm formData, Long id) {
<span class="fc" id="L58">        Channel channel = ConvertUtil.convert(formData, Channel.class);</span>
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">        if (channel != null) {</span>
<span class="fc" id="L60">            channel.setId(id);</span>
<span class="pc bpc" id="L61" title="1 of 2 branches missed.">            if (channelApi.getChannelById(channel.getId()) == null) {</span>
<span class="nc" id="L62">                throw new ApiException(&quot;Channel with given Id does not exit, id: &quot; + channel.getId());</span>
            }
<span class="pc bpc" id="L64" title="1 of 2 branches missed.">            if(channelApi.getChannelDetails(channel.getName()) != null){</span>
<span class="nc" id="L65">                throw new ApiException(&quot;Duplicate name found while updating Channel Name&quot;);</span>
            }
<span class="fc" id="L67">            channelApi.updateChannel(channel);</span>
        }
<span class="fc" id="L69">    }</span>

    @Transactional(readOnly = true)
    public ChannelDataResponse getChannelDetails(Long id) {
<span class="fc" id="L73">        Channel channel = channelApi.getChannelById(id);</span>
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">        if(channel==null){</span>
<span class="nc" id="L75">            throw new ApiException(&quot;No Channel found. Please add channel first.&quot;);</span>
        }
<span class="fc" id="L77">        return ConvertUtil.convert(channel, ChannelDataResponse.class);</span>
    }

    @Transactional(readOnly = true)
    public List&lt;ChannelDataResponse&gt; getAllChannelDetails(Long clientId) {
<span class="nc" id="L82">        Set&lt;Long&gt; channelIdSet = channelListingApi.getUniqueChannelIdByClientId(clientId);</span>
<span class="nc" id="L83">        List&lt;Channel&gt; channelList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        for(Long channelId : channelIdSet){</span>
<span class="nc" id="L85">            Channel channel = channelApi.getChannelById(channelId);</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            if(channel==null){</span>
<span class="nc" id="L87">                continue;</span>
            }
<span class="nc" id="L89">            channelList.add(channel);</span>
<span class="nc" id="L90">        }</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">        if(channelList.isEmpty()){</span>
<span class="nc" id="L92">            throw new ApiException(&quot;No Channel-Items found for selected client. Please add Channel-items first.&quot;);</span>
        }
<span class="nc" id="L94">        return ConvertUtil.convert(channelList, ChannelDataResponse.class);</span>
    }

    @Transactional(readOnly = true)
    public List&lt;ChannelDataResponse&gt; getAllChannelDetails() {
<span class="nc" id="L99">        List&lt;Channel&gt; channelList = channelApi.getAllChannelDetails();</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if(channelList.isEmpty()){</span>
<span class="nc" id="L101">            throw new ApiException(&quot;No Channel data found. Please create Channel first.&quot;);</span>
        }
<span class="nc" id="L103">        return ConvertUtil.convert(channelList, ChannelDataResponse.class);</span>
    }

    public void postOrderDetails(ChannelOrderForm formData) {
<span class="nc" id="L107">        orderClient.postOrderDetails(formData);</span>
<span class="nc" id="L108">    }</span>

    @Transactional(readOnly = true)
    public List&lt;OrderDataResponse&gt; getAllChannelOrderList(Long channelId) {
        List&lt;OrderDataResponse&gt; ordersDataList;
<span class="nc" id="L113">        ordersDataList = orderClient.getOrderDetails(channelId);</span>
<span class="nc" id="L114">        return ordersDataList;</span>
    }

    @Transactional(readOnly = true)
    public List&lt;OrderItemDataResponse&gt; getChannelOrderItems(Long orderId, Long channelId){
        List&lt;OrderItemDataResponse&gt; itemResponseList;
<span class="nc" id="L120">        List&lt;OrderItemDataResponse&gt; itemList = itemClient.getOrderItemDetails(orderId);</span>
<span class="nc" id="L121">        itemResponseList = ConvertUtil.convert(itemList, OrderItemDataResponse.class);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">        if (itemResponseList != null) {</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">            for(int i=0; i&lt;itemList.size(); i++){</span>
<span class="nc" id="L124">                ChannelListing listing = channelListingApi.getChannelListing(itemList.get(i).getGlobalSkuId(), channelId);</span>
<span class="nc" id="L125">                itemResponseList.get(i).setSkuId(listing.getChannelSkuId());</span>
            }
        }
<span class="nc" id="L128">        return itemResponseList;</span>
    }

    public void generatePdf(OrderDataResponse orderData) {
<span class="nc" id="L132">        logger.info(&quot;generate here&quot;);</span>
<span class="nc" id="L133">        List&lt;InvoiceOrderItemData&gt; invoiceItemList = itemClient.getOrderItemDataForInvoice(orderData.getId());</span>
<span class="nc" id="L134">        logger.info(&quot;here list : &quot;+invoiceItemList.size());</span>
<span class="nc" id="L135">        InvoiceData data = populateInvoiceData(orderData, invoiceItemList);</span>
<span class="nc" id="L136">        logger.info(&quot;here data &quot;+data);</span>
<span class="nc" id="L137">        pdfCreator(data);</span>
<span class="nc" id="L138">    }</span>

    private InvoiceData populateInvoiceData(OrderDataResponse order, List&lt;InvoiceOrderItemData&gt; invoiceItemList) {
<span class="nc" id="L141">        InvoiceData data = new InvoiceData();</span>
<span class="nc" id="L142">        InvoiceOrderData orderData = new InvoiceOrderData();</span>
<span class="nc" id="L143">        orderData.setOrderId(order.getId());</span>
<span class="nc" id="L144">        orderData.setChannelOrderId(order.getChannelOrderId());</span>
<span class="nc" id="L145">        orderData.setClientName(order.getClientName());</span>
<span class="nc" id="L146">        orderData.setCustomerName(order.getCustomerName());</span>
<span class="nc" id="L147">        orderData.setChannelId(order.getChannelId());</span>
<span class="nc" id="L148">        data.setOrderData(orderData);</span>
<span class="nc" id="L149">        data.setInvoiceOrderItemDataList(invoiceItemList);</span>
<span class="nc" id="L150">        logger.info(&quot;populate here &quot;+ data.getInvoiceOrderItemDataList().size());</span>
<span class="nc" id="L151">        logger.info(&quot;populate here chOr &quot; + orderData.getChannelOrderId());</span>
<span class="nc" id="L152">        logger.info(&quot;populate here clN &quot;+ orderData.getClientName());</span>
<span class="nc" id="L153">        logger.info(&quot;populate here cuN &quot;+ orderData.getCustomerName());</span>
<span class="nc" id="L154">        logger.info(&quot;populate here oID &quot;+ orderData.getOrderId());</span>
<span class="nc" id="L155">        return data;</span>
    }

    public void pdfCreator(InvoiceData data) {
<span class="nc" id="L159">        logger.info(&quot;pdfcreator here&quot;);</span>
        try {
<span class="nc" id="L161">            PDFHandler.createInvoicePdf(data,PDF_PATH, INVOICE_TEMPLATE_XSL);</span>
<span class="nc" id="L162">            logger.info(&quot;pdf created here&quot;);</span>
<span class="nc" id="L163">        } catch (Exception e) {</span>
<span class="nc" id="L164">            e.printStackTrace();</span>
<span class="nc" id="L165">            logger.info(e.getClass());</span>
<span class="nc" id="L166">        }</span>
<span class="nc" id="L167">    }</span>

    @Transactional
    public byte[] getPDfInBytes(String fileName) throws IOException {
        byte[] fileInBytes;
<span class="nc" id="L172">        File file = new File(String.valueOf(Paths.get(PDF_PATH+fileName+&quot;.pdf&quot;)));</span>
<span class="nc bnc" id="L173" title="All 4 branches missed.">        if(!(file.exists() &amp;&amp; file.isFile())) {</span>
<span class="nc" id="L174">            byte[] clientByteResponse = pdfClient.getInvoicePDF(fileName);</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">            if(clientByteResponse == null) {</span>
<span class="nc" id="L176">                throw new ApiException(&quot;Invoice Pdf not found with name : &quot;+ fileName);</span>
            }
<span class="nc" id="L178">            logger.info(&quot;got pdf &quot;+ clientByteResponse.length);</span>
//            FileOutputStream fos = new FileOutputStream(file);
//            fos.write(clientByteResponse);
//            BufferedOutputStream bos = new BufferedOutputStream(fos);
//            bos.write(clientByteResponse);
//            bos.flush();
//            fos.close();
//            logger.info(file.exists());
<span class="nc" id="L186">            return Base64.getEncoder().encode(clientByteResponse);</span>
        }
<span class="nc" id="L188">        fileInBytes = Files.readAllBytes(Paths.get(PDF_PATH+fileName+&quot;.pdf&quot;));</span>
<span class="nc" id="L189">        logger.info(fileInBytes.length);</span>
<span class="nc" id="L190">        return Base64.getEncoder().encode(fileInBytes);</span>
    }

    @Transactional(readOnly = true)
    public List&lt;ClientDataResponse&gt; getAllCustomers() {
<span class="nc" id="L195">        return clientClient.getCustomerDetails();</span>
    }

    @Transactional(readOnly = true)
    public List&lt;ClientDataResponse&gt; getAllClients() {
<span class="nc" id="L200">        return clientClient.getClientDetails();</span>
    }

    @Transactional(readOnly = true)
    public List&lt;OrderDataResponse&gt; getOrderDataForClient(long clientId) {
<span class="nc" id="L205">        List&lt;OrderDataResponse&gt; allOrderDetails = orderClient.getAllOrderDetails(clientId);</span>
<span class="nc" id="L206">        List&lt;OrderDataResponse&gt; responses = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">        for(OrderDataResponse orderData : allOrderDetails){</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">            if(!orderData.getChannelName().equals(&quot;INTERNAL&quot;)){</span>
<span class="nc" id="L209">                responses.add(orderData);</span>
            }
<span class="nc" id="L211">        }</span>
<span class="nc" id="L212">        return responses;</span>
    }

    @Transactional(readOnly = true)
    public Channel getChannelByName(String clientName) {
<span class="nc" id="L217">        return channelApi.getChannelDetails(clientName);</span>
    }

    @Transactional(readOnly = true)
    public Channel getChannelDetail(Long channelId) {
<span class="nc" id="L222">        return channelApi.getChannelById(channelId);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>